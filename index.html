<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CAFE LEGENDAIRE</title>
<meta name="theme-color" content="#3a2a1d">

<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
<script src="https://unpkg.com/html5-qrcode"></script>

<style>
body{margin:0;font-family:Arial}
body::before{
  content:"";
  position:fixed;
  inset:0;
  background:url("IMG_0069.jpeg") center/cover no-repeat;
  filter:blur(6px) brightness(0.9);
  z-index:-1;
}
header{
  background:rgba(34,34,34,.9);
  color:#fff;
  padding:14px;
  text-align:center;
  font-size:22px;
  font-weight:bold;
}
.container{padding:10px}
.panel,.product,.cart{
  background:rgba(255,255,255,.93);
  border-radius:8px;
  padding:10px;
  margin-top:12px;
}
.products{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
.product{position:relative}
button{
  width:100%;padding:10px;margin-top:6px;border:none;border-radius:6px;
  font-size:15px;color:#fff;cursor:pointer;
}
.green{background:#28a745}
.red{background:#dc3545}
.blue{background:#007bff}
.gray{background:#6c757d}
.hidden{display:none}
</style>
</head>

<body>

<header>‚òï CAFE LEGENDAIRE</header>

<div class="container">

<div class="panel">
<select id="worker">
<option>Ismat</option>
<option>Ahmed</option>
<option>Admin 3</option>
<option>Admin 4</option>
<option>Admin 5</option>
<option>Admin 6</option>
<option>Admin 7</option>
</select>

<select id="shift"></select>
<button class="gray" onclick="endShift()">‚è± End Shift</button>
</div>

<h3>Products</h3>

<button class="blue" onclick="addProduct()">‚ûï Add Product</button>

<div class="products" id="products"></div>

<div class="cart">
<h3>Current Order</h3>
<div id="cartItems"></div>
<b>Total: <span id="total">0</span> DA</b>
<button class="green" onclick="checkout()">‚úî Validate Order</button>
<button class="red" onclick="clearCart()">‚úñ Clear</button>
</div>

<div class="panel">
<input type="password" id="pin" placeholder="Admin PIN">
<button class="gray" onclick="openAdmin()">üîê Admin</button>

<div id="admin" class="hidden">
<button class="blue" onclick="showShiftReport('Morning')">Morning shift</button>
<button class="blue" onclick="showShiftReport('Evening')">Evening shift</button>
<button class="blue" onclick="exportExcel()">üì• Export Excel</button>
<button class="red" onclick="cleanPOS()">üßπ Clean</button>

<div id="reports"></div>
</div>
</div>

</div>

<script>
/* FIREBASE */
const firebaseConfig={
  apiKey:"AIzaSyCdWSIrpEwi4o83WVNoMd2D36W0ngaJC28",
  authDomain:"cafe-legendaire-pos.firebaseapp.com",
  projectId:"cafe-legendaire-pos",
  storageBucket:"cafe-legendaire-pos.firebasestorage.app",
  messagingSenderId:"548449258422",
  appId:"1:548449258422:web:ab140347d114bf9d82cf17"
};
firebase.initializeApp(firebaseConfig);
const db=firebase.firestore();

const ADMIN_PIN="5554";
let PRODUCTS=[], SALES=[], cart=[];
let SHIFT="Morning";
let shiftStartTime=new Date().toLocaleTimeString();
let shiftEndTime="";

shift.innerHTML=`<option>${SHIFT}</option>`;

db.collection("products").onSnapshot(s=>{
  PRODUCTS=s.docs.map(d=>({...d.data(),id:d.id}));
  render();
});
db.collection("sales").onSnapshot(s=>{
  SALES=s.docs.map(d=>({...d.data(),id:d.id}));
});

function endShift(){
  shiftEndTime=new Date().toLocaleTimeString();
  SHIFT=SHIFT==="Morning"?"Evening":"Morning";
  shiftStartTime=new Date().toLocaleTimeString();
  shift.innerHTML=`<option>${SHIFT}</option>`;
}

function render(){
  products.innerHTML="";
  PRODUCTS.forEach(p=>{
    let d=document.createElement("div");
    d.className="product";
    d.innerHTML=`<b>${p.name}</b><br>${p.price} DA<br>Stock:${p.stock}`;
    d.onclick=()=>addToCart(p.id);
    products.appendChild(d);
  });
}

function addProduct(){
  let n=prompt("Name"); if(!n)return;
  let p=parseInt(prompt("Price")); if(isNaN(p))return;
  let s=parseInt(prompt("Stock"))||0;
  db.collection("products").doc(n).set({name:n,price:p,stock:s});
}

function addToCart(id){
  let p=PRODUCTS.find(x=>x.id===id);
  if(p.stock<=0)return;
  p.stock--;db.collection("products").doc(id).set(p);
  cart.push(p);renderCart();
}

function renderCart(){
  cartItems.innerHTML="";let t=0;
  cart.forEach(p=>{t+=p.price;
    cartItems.innerHTML+=`${p.name} ${p.price} DA<br>`;
  });
  total.innerText=t;
}

function clearCart(){
  cart.forEach(p=>{p.stock++;db.collection("products").doc(p.id).set(p);});
  cart=[];renderCart();
}

function checkout(){
  if(!cart.length)return;

  let map={};
  cart.forEach(p=>{
    map[p.name]=map[p.name]||{qty:0,price:p.price};
    map[p.name].qty++;
  });

  let items=Object.keys(map).map(n=>({
    name:n,qty:map[n].qty,price:map[n].price
  }));

  db.collection("sales").add({
    shift:SHIFT,
    shiftStart:shiftStartTime,
    admin:worker.value,
    total:cart.reduce((a,b)=>a+b.price,0),
    items:items
  });

  cart=[];renderCart();
}

function openAdmin(){
  if(pin.value!==ADMIN_PIN)return alert("Wrong PIN");
  admin.classList.toggle("hidden");
}

function showShiftReport(shiftName){
  let stats={}, total=0;
  SALES.forEach(s=>{
    if(s.shift!==shiftName)return;
    total+=s.total;
    s.items.forEach(i=>{
      stats[i.name]=(stats[i.name]||0)+i.qty;
    });
  });

  let html=`<b>${shiftName} shift</b><br>`;
  Object.keys(stats).forEach(p=>{
    html+=`${p} : ${stats[p]} units<br>`;
  });
  html+=`<br><b>Total: ${total} DA</b>`;
  reports.innerHTML=html;
}

function exportExcel(){
  let csv="Shift,Shift Start,Shift End,User,Product,Units,Total (DA)\n";

  SALES.forEach(s=>{
    s.items.forEach(i=>{
      csv+=`${s.shift},${s.shiftStart || ""},${shiftEndTime},${s.admin},${i.name},${i.qty},${s.total}\n`;
    });
  });

  let a=document.createElement("a");
  a.href=URL.createObjectURL(new Blob([csv],{type:"text/csv"}));
  a.download="CAFE_LEGENDAIRE_SHIFT_REPORT.csv";
  a.click();
}

function cleanPOS(){
  if(!confirm("Delete all sales?"))return;
  db.collection("sales").get().then(snap=>snap.forEach(d=>d.ref.delete()));
  reports.innerHTML="";
  SHIFT="Morning";
  shiftStartTime=new Date().toLocaleTimeString();
  shift.innerHTML=`<option>${SHIFT}</option>`;
  alert("POS cleaned");
}
</script>

</body>
</html>
