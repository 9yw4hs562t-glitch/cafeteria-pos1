<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CAFE LEGENDAIRE</title>
<meta name="theme-color" content="#3a2a1d">

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

<!-- Barcode -->
<script src="https://unpkg.com/html5-qrcode"></script>

<style>
body{margin:0;font-family:Arial}
body::before{
  content:"";
  position:fixed;
  inset:0;
  background:url("IMG_0069.jpeg") center/cover no-repeat;
  filter:blur(6px) brightness(0.9);
  z-index:-1;
}
header{
  background:rgba(34,34,34,.9);
  color:#fff;
  padding:14px;
  text-align:center;
  font-size:22px;
  font-weight:bold;
}
.container{padding:10px}
.panel,.product,.cart{
  background:rgba(255,255,255,.93);
  backdrop-filter:blur(2px);
  border-radius:8px;
  padding:10px;
  margin-top:12px;
  box-shadow:0 3px 8px rgba(0,0,0,.25);
}
.products{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
.product{position:relative}
.menu{position:absolute;top:6px;right:8px;font-size:18px;cursor:pointer}
.small{font-size:12px;color:#444}
button{
  width:100%;padding:10px;margin-top:6px;border:none;border-radius:6px;
  font-size:15px;color:#fff;cursor:pointer;
}
.green{background:#28a745}
.red{background:#dc3545}
.blue{background:#007bff}
.gray{background:#6c757d}
.filter{display:flex;gap:6px;margin:10px 0}
.filter button{flex:1}
.hidden{display:none}
#scanner{margin-top:10px}
</style>
</head>

<body>

<header>‚òï CAFE LEGENDAIRE</header>

<div class="container">

<div class="panel">
<select id="worker">
<option>Ismat</option>
<option>Ahmed</option>
<option>Admin 3</option>
<option>Admin 4</option>
<option>Admin 5</option>
<option>Admin 6</option>
<option>Admin 7</option>
</select>

<select id="shift"></select>
<button class="gray" onclick="endShift()">‚è± End Shift</button>
</div>

<h3>Products</h3>

<div class="filter">
<button class="gray" onclick="setFilter('all')">All</button>
<button class="blue" onclick="setFilter('Drink')">Drinks</button>
<button class="green" onclick="setFilter('Food')">Food</button>
</div>

<button class="blue" onclick="addProduct()">‚ûï Add Product</button>
<button class="gray" onclick="toggleScanSell()">üì∑ Scan (Sell)</button>

<div id="scanner" class="hidden"></div>
<div class="products" id="products"></div>

<div class="cart">
<h3>Current Order</h3>
<div id="cartItems"></div>
<b>Total: <span id="total">0</span> DA</b>
<button class="green" onclick="checkout()">‚úî Validate Order</button>
<button class="red" onclick="clearCart()">‚úñ Clear</button>
</div>

<div class="panel">
<input type="password" id="pin" placeholder="Admin PIN">
<button class="gray" onclick="openAdmin()">üîê Admin</button>

<div id="admin" class="hidden">
<h4>üìä Accounting</h4>
<button class="blue" onclick="report('shift')">Shift</button>
<button class="blue" onclick="report('day')">Day</button>
<button class="blue" onclick="report('week')">Week</button>
<button class="blue" onclick="report('month')">Month</button>

<button class="blue" onclick="exportExcel()">üì• Export Excel</button>
<button class="red" onclick="archiveDay()">üìÖ Archive & Reset Day</button>

<div id="reports"></div>
</div>
</div>

</div>

<script>
/* ================= FIREBASE CONFIG ================= */
const firebaseConfig = {
  apiKey: "AIzaSyCdWSIrpEwi4o83WVNoMd2D36W0ngaJC28",
  authDomain: "cafe-legendaire-pos.firebaseapp.com",
  projectId: "cafe-legendaire-pos",
  storageBucket: "cafe-legendaire-pos.firebasestorage.app",
  messagingSenderId: "548449258422",
  appId: "1:548449258422:web:ab140347d114bf9d82cf17"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

/* ================= DATA ================= */
const ADMIN_PIN = "5554";
let PRODUCTS = [];
let SALES = [];
let cart = [];
let filter = "all";
let SHIFT = "Morning";

shift.innerHTML = `<option>${SHIFT}</option>`;

/* ================= REALTIME SYNC ================= */
db.collection("products").onSnapshot(snap=>{
  PRODUCTS = snap.docs.map(d=>({...d.data(), id:d.id}));
  render();
});

db.collection("sales").onSnapshot(snap=>{
  SALES = snap.docs.map(d=>d.data());
});

/* ================= UI ================= */
function setFilter(c){filter=c;render();}
function endShift(){
  SHIFT = SHIFT==="Morning"?"Evening":"Morning";
  shift.innerHTML=`<option>${SHIFT}</option>`;
}

function render(){
  products.innerHTML="";
  PRODUCTS.forEach(p=>{
    if(filter!=="all" && p.cat!==filter) return;
    let d=document.createElement("div");
    d.className="product";
    d.innerHTML=`
      <div class="menu" onclick="productMenu('${p.id}')">‚ãÆ</div>
      <b>${p.name}</b><br>
      <span class="small">${p.price} DA ‚Äì ${p.cat}</span><br>
      <span class="small">Stock: ${p.stock}</span>`;
    d.onclick=()=>addToCart(p.id);
    products.appendChild(d);
  });
}

/* ================= INVENTORY ================= */
function addProduct(){
  let name=prompt("Name"); if(!name) return;
  let price=parseInt(prompt("Price")); if(isNaN(price)) return;
  let cat=prompt("Category");
  let stock=parseInt(prompt("Stock"))||0;
  db.collection("products").doc(name).set({name,price,cat,stock,code:""});
}

let scanAssignId=null;
function productMenu(id){
  let p=PRODUCTS.find(x=>x.id===id);
  let c=prompt("1 Modify\n2 Stock +/-\n3 Scan barcode\n4 Delete");
  if(c==="1"){
    let n=prompt("Name",p.name);
    let pr=parseInt(prompt("Price",p.price));
    if(n)p.name=n;
    if(!isNaN(pr))p.price=pr;
  }
  if(c==="2"){
    let q=parseInt(prompt("Stock change"));
    if(!isNaN(q)){p.stock+=q;if(p.stock<0)p.stock=0;}
  }
  if(c==="3"){scanAssignId=id;scanAssign();return;}
  if(c==="4"){if(confirm("Delete?")) db.collection("products").doc(id).delete();return;}
  db.collection("products").doc(id).set(p);
}

/* ================= CART ================= */
function addToCart(id){
  let p=PRODUCTS.find(x=>x.id===id);
  if(p.stock<=0) return alert("Out of stock");
  p.stock--;
  db.collection("products").doc(id).set(p);
  cart.push(p);
  render();renderCart();
}

function renderCart(){
  cartItems.innerHTML="";let t=0;
  cart.forEach((p,i)=>{
    t+=p.price;
    cartItems.innerHTML+=`${p.name} - ${p.price} DA <span onclick="removeItem(${i})">‚úñ</span><br>`;
  });
  total.innerText=t;
}

function removeItem(i){
  let p=cart[i];
  p.stock++;
  db.collection("products").doc(p.id).set(p);
  cart.splice(i,1);
  render();renderCart();
}

function clearCart(){
  cart.forEach(p=>{
    p.stock++;
    db.collection("products").doc(p.id).set(p);
  });
  cart=[];render();renderCart();
}

function checkout(){
  if(!cart.length)return;
  db.collection("sales").add({
    date:new Date().toLocaleDateString(),
    time:new Date().toLocaleTimeString(),
    shift:SHIFT,
    admin:worker.value,
    total:cart.reduce((a,b)=>a+b.price,0)
  });
  cart=[];render();renderCart();
}

/* ================= SCAN SELL ================= */
let scanOpen=false,scanInstance=null;
function toggleScanSell(){
  if(scanOpen){
    scanInstance.stop();scanner.classList.add("hidden");scanOpen=false;return;
  }
  scanner.classList.remove("hidden");
  scanInstance=new Html5Qrcode("scanner");
  scanInstance.start({facingMode:"environment"},{fps:10,qrbox:250},code=>{
    let p=PRODUCTS.find(x=>x.code===code);
    if(!p) return alert("Not found");
    addToCart(p.id);
  });
  scanOpen=true;
}

/* ================= SCAN ASSIGN ================= */
function scanAssign(){
  scanner.classList.remove("hidden");
  let qr=new Html5Qrcode("scanner");
  qr.start({facingMode:"environment"},{fps:10,qrbox:250},code=>{
    qr.stop();scanner.classList.add("hidden");
    let p=PRODUCTS.find(x=>x.id===scanAssignId);
    p.code=code;
    db.collection("products").doc(p.id).set(p);
  });
}

/* ================= ADMIN ================= */
function openAdmin(){
  if(pin.value!==ADMIN_PIN) return alert("Wrong PIN");
  admin.classList.toggle("hidden");
}

function report(type){
  let now=new Date(),sum=0,count=0;
  SALES.forEach(s=>{
    let d=new Date(s.date);
    if(type==="shift"&&s.shift!==SHIFT)return;
    if(type==="day"&&d.toDateString()!==now.toDateString())return;
    if(type==="week"&&now-d>7*86400000)return;
    if(type==="month"&&d.getMonth()!==now.getMonth())return;
    sum+=s.total;count++;
  });
  reports.innerHTML=`Orders: ${count}<br>Total: ${sum} DA`;
}

/* ================= EXPORT & ARCHIVE ================= */
function exportExcel(){
  let csv="Date,Time,Shift,Admin,Total\n";
  SALES.forEach(s=>csv+=`${s.date},${s.time},${s.shift},${s.admin},${s.total}\n`);
  let a=document.createElement("a");
  a.href=URL.createObjectURL(new Blob([csv],{type:"text/csv"}));
  a.download="CAFE_LEGENDAIRE_TODAY.csv";
  a.click();
}

function archiveDay(){
  if(!confirm("Archive today and reset POS?")) return;
  let today=new Date().toISOString().split("T")[0];
  db.collection("archives").doc(today).set({date:today,sales:SALES});
  db.collection("sales").get().then(snap=>snap.forEach(d=>d.ref.delete()));
  cart=[];SHIFT="Morning";shift.innerHTML=`<option>${SHIFT}</option>`;
  reports.innerHTML="";
  alert("Day archived successfully");
}
</script>

</body>
</html>
