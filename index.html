<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CAFE LEGENDAIRE POS</title>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

<!-- Barcode -->
<script src="https://unpkg.com/html5-qrcode"></script>

<style>
body{margin:0;font-family:Segoe UI,Arial;background:#000}
body::before{
  content:"";
  position:fixed;
  inset:0;
  background:url("IMG_0069.jpeg") center/cover no-repeat;
  filter:blur(8px) brightness(.8);
  z-index:-1;
}
header{
  background:rgba(0,0,0,.85);
  color:#fff;
  padding:16px;
  text-align:center;
  font-size:24px;
  letter-spacing:2px;
}
.app{
  display:grid;
  grid-template-columns:1fr;
  gap:12px;
  padding:12px;
}
@media(min-width:1000px){
  .app{grid-template-columns:2.5fr 1.5fr 1.5fr;height:calc(100vh - 80px)}
}
.card{
  background:rgba(255,255,255,.95);
  border-radius:12px;
  padding:12px;
  box-shadow:0 6px 20px rgba(0,0,0,.3);
  display:flex;
  flex-direction:column;
}
.products{
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(140px,1fr));
  gap:10px;
}
.product{
  background:#fff;
  border-radius:10px;
  padding:10px;
  cursor:pointer;
}
.menu{float:right;font-size:18px}
.small{font-size:12px;color:#555}
button{
  padding:10px;
  margin-top:6px;
  border:none;
  border-radius:8px;
  font-size:15px;
  cursor:pointer;
}
.blue{background:#007bff;color:#fff}
.green{background:#28a745;color:#fff}
.red{background:#dc3545;color:#fff}
.gray{background:#6c757d;color:#fff}
.cart-items,.history{flex:1;overflow:auto}
.history-item{
  padding:8px;
  border-bottom:1px solid #ddd;
  cursor:pointer;
}
.history-item:hover{background:#f3f3f3}
.hidden{display:none}
</style>
</head>

<body>

<header>â˜• CAFE LEGENDAIRE</header>

<div class="app">

<!-- PRODUCTS -->
<div class="card">
<h3>Products</h3>
<button class="blue" onclick="addProduct()">âž• Add Product</button>
<button class="gray" onclick="toggleScanSell()">ðŸ“· Scan (Sell)</button>
<div id="scanner" class="hidden"></div>
<div class="products" id="products"></div>
</div>

<!-- CART -->
<div class="card">
<h3>Current Order</h3>
<select id="worker">
<option>Ismat</option>
<option>Ahmed</option>
</select>
<select id="shift">
<option>Morning</option>
<option>Evening</option>
</select>

<div class="cart-items" id="cartItems"></div>
<h3>Total: <span id="total">0</span> DA</h3>
<button class="green" onclick="checkout()">âœ” Validate</button>
<button class="red" onclick="clearCart()">âœ– Clear</button>
</div>

<!-- HISTORY + ADMIN -->
<div class="card">
<h3>ðŸ§¾ Orders History</h3>
<div class="history" id="history"></div>

<hr>
<input type="password" id="pin" placeholder="Admin PIN">
<button class="gray" onclick="openAdmin()">Admin</button>

<div id="admin" class="hidden">
<h4>ðŸ“Š Shift Accounting</h4>

<button class="blue" onclick="showShift('Morning')">Morning Shift</button>
<button class="blue" onclick="showShift('Evening')">Evening Shift</button>

<div id="reports"></div>

<button class="blue" onclick="exportShift()">ðŸ“¥ Export Shift Excel</button>
<button class="red" onclick="clearShift()">ðŸ§¹ Clear Shift Sales</button>
</div>
</div>

</div>

<script>
/* FIREBASE */
const firebaseConfig={
  apiKey:"AIzaSyCdWSIrpEwi4o83WVNoMd2D36W0ngaJC28",
  authDomain:"cafe-legendaire-pos.firebaseapp.com",
  projectId:"cafe-legendaire-pos",
  storageBucket:"cafe-legendaire-pos.firebasestorage.app",
  messagingSenderId:"548449258422",
  appId:"1:548449258422:web:ab140347d114bf9d82cf17"
};
firebase.initializeApp(firebaseConfig);
const db=firebase.firestore();

/* DATA */
const ADMIN_PIN="5554";
let PRODUCTS=[],SALES=[],cart=[],ACTIVE_SHIFT="Morning";

/* SYNC */
db.collection("products").onSnapshot(s=>{
  PRODUCTS=s.docs.map(d=>({...d.data(),id:d.id}));
  renderProducts();
});
db.collection("sales").orderBy("timestamp","desc").onSnapshot(s=>{
  SALES=s.docs.map(d=>({...d.data(),id:d.id}));
  renderHistory();
});

/* PRODUCTS */
function renderProducts(){
  products.innerHTML="";
  PRODUCTS.forEach(p=>{
    let d=document.createElement("div");
    d.className="product";
    d.innerHTML=`<b>${p.name}</b><br>
    <span class="small">${p.price} DA | Stock ${p.stock}</span>`;
    d.onclick=()=>addToCart(p.id);
    products.appendChild(d);
  });
}
function addProduct(){
  let n=prompt("Name");if(!n)return;
  let p=parseInt(prompt("Price"));if(isNaN(p))return;
  let s=parseInt(prompt("Stock"))||0;
  db.collection("products").doc(n).set({name:n,price:p,stock:s,code:""});
}

/* CART */
function addToCart(id){
  let p=PRODUCTS.find(x=>x.id===id);
  if(p.stock<=0)return;
  p.stock--;db.collection("products").doc(id).set(p);
  cart.push(p);renderCart();
}
function renderCart(){
  cartItems.innerHTML="";let t=0;
  cart.forEach(p=>{t+=p.price;
    cartItems.innerHTML+=`<div>${p.name}<span>${p.price} DA</span></div>`;
  });
  total.innerText=t;
}
function clearCart(){
  cart.forEach(p=>{p.stock++;db.collection("products").doc(p.id).set(p);});
  cart=[];renderCart();
}

/* CHECKOUT */
function checkout(){
  if(!cart.length)return;
  let items={};
  cart.forEach(p=>items[p.name]=(items[p.name]||0)+1);
  let order=Object.keys(items).map(n=>{
    let p=cart.find(x=>x.name===n);
    return {name:n,price:p.price,qty:items[n]};
  });
  db.collection("sales").add({
    timestamp:Date.now(),
    date:new Date().toLocaleDateString(),
    time:new Date().toLocaleTimeString(),
    shift:shift.value,
    admin:worker.value,
    total:cart.reduce((a,b)=>a+b.price,0),
    items:order
  });
  cart=[];renderCart();
}

/* HISTORY */
function renderHistory(){
  history.innerHTML="";
  SALES.forEach(s=>{
    let d=document.createElement("div");
    d.className="history-item";
    d.innerHTML=`${s.time} â€¢ ${s.admin} â€¢ <b>${s.total} DA</b>`;
    d.onclick=()=>viewOrder(s);
    history.appendChild(d);
  });
}
function viewOrder(o){
  let txt=`${o.time} (${o.shift})\n${o.admin}\n\n`;
  o.items.forEach(i=>txt+=`${i.name} x${i.qty}\n`);
  txt+=`\nTOTAL ${o.total} DA`;
  alert(txt);
}

/* ADMIN */
function openAdmin(){
  if(pin.value!==ADMIN_PIN)return alert("Wrong PIN");
  admin.classList.toggle("hidden");
}
function showShift(s){
  ACTIVE_SHIFT=s;
  let sum=0,count=0;
  SALES.forEach(o=>{if(o.shift===s){sum+=o.total;count++;}});
  reports.innerHTML=`${s} Orders: ${count}<br>Total: ${sum} DA`;
}
function exportShift(){
  let csv="Date,Time,Admin,Total\n";
  SALES.filter(o=>o.shift===ACTIVE_SHIFT)
       .forEach(o=>csv+=`${o.date},${o.time},${o.admin},${o.total}\n`);
  let a=document.createElement("a");
  a.href=URL.createObjectURL(new Blob([csv],{type:"text/csv"}));
  a.download=`${ACTIVE_SHIFT}_SHIFT.csv`;
  a.click();
}
function clearShift(){
  if(!confirm("Clear sales for "+ACTIVE_SHIFT+" shift?"))return;
  SALES.filter(o=>o.shift===ACTIVE_SHIFT)
       .forEach(o=>db.collection("sales").doc(o.id).delete());
  reports.innerHTML="";
}

/* SCAN */
let scanOpen=false,scanInstance=null;
function toggleScanSell(){
  if(scanOpen){
    scanInstance.stop();scanner.classList.add("hidden");scanOpen=false;return;
  }
  scanner.classList.remove("hidden");
  scanInstance=new Html5Qrcode("scanner");
  scanInstance.start({facingMode:"environment"},{fps:10,qrbox:250},code=>{
    let p=PRODUCTS.find(x=>x.code===code);
    if(!p)return alert("Not found");
    addToCart(p.id);
  });
  scanOpen=true;
}
</script>

</body>
</html>
